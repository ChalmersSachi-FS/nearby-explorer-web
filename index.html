<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nearby Explorer — Web</title>

    <!-- Mapbox CSS (CDN) - keep this in head -->
    <link
      id="mapbox-css"
      href="https://api.mapbox.com/mapbox-gl-js/v2.16.0/mapbox-gl.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="styles.css" />
    <style>
      /* small fallback so the map area is visible while loading */
      #map {
        min-height: 320px;
      }
      .loader-note {
        position: fixed;
        left: 12px;
        top: 12px;
        background: #fff3f3;
        padding: 8px;
        border: 1px solid #f2a0a0;
        z-index: 9999;
        border-radius: 6px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div
      class="loader-note"
      id="loader-note"
      role="alert"
      aria-live="polite"
    ></div>

    <header class="site-header">
      <h1>Nearby Explorer</h1>
      <div class="header-controls">
        <button id="btn-refresh-location">Refresh Location</button>
        <select id="select-category" aria-label="Category">
          <option value="restaurant">Restaurants</option>
          <option value="cafe">Cafes</option>
          <option value="shop">Shops</option>
          <option value="bar">Bars</option>
          <option value="park">Parks</option>
          <option value="atm">ATMs</option>
        </select>
        <button id="btn-search">Find Nearby</button>
        <button id="btn-toggle-view">List View</button>
      </div>
    </header>

    <main class="main-grid">
      <section class="map-pane">
        <div id="map" class="map" aria-label="Map showing nearby places"></div>
        <div class="map-overlay">
          <div id="user-info">
            Location: <span id="user-coords">unknown</span>
          </div>
          <div id="map-status" class="status muted">Idle</div>
        </div>
      </section>

      <aside class="list-pane">
        <div class="list-header">
          <h2>Nearby Places</h2>
          <div id="places-loading" class="muted small">Idle</div>
        </div>
        <ul id="places-list" class="places-list"></ul>

        <div class="place-details" id="place-details" hidden>
          <h3 id="detail-name"></h3>
          <p id="detail-address"></p>
          <p id="detail-distance"></p>

          <div id="photo-thumbs" class="photo-thumbs"></div>

          <div class="detail-actions">
            <input
              id="photo-input"
              type="file"
              accept="image/*"
              capture="environment"
              style="display: none"
            />
            <button id="btn-take-photo">Take Photo</button>
            <button id="btn-share" disabled>Share</button>
            <button id="btn-close-details">Close</button>
          </div>
        </div>
      </aside>
    </main>

    <template id="place-item-template">
      <li class="place-item">
        <div class="place-main">
          <div class="place-title"></div>
          <div class="place-sub muted"></div>
        </div>
        <div class="place-actions">
          <button class="btn-view">View</button>
          <button class="btn-photo">Photo</button>
        </div>
      </li>
    </template>

    <footer class="site-footer">
      <small class="muted"
        >Built with Mapbox & browser APIs — replace tokens in app.js</small
      >
    </footer>

    <script>
      (function dynamicLoadMapbox() {
        const loaderNote = document.getElementById("loader-note");
        function showNote(msg) {
          loaderNote.textContent = msg;
          loaderNote.style.display = "block";
        }
        // URLs to try (primary then fallback)
        const scriptUrls = [
          "https://api.mapbox.com/mapbox-gl-js/v2.16.0/mapbox-gl.js", // official
          "https://unpkg.com/mapbox-gl@2.16.0/dist/mapbox-gl.js", // fallback
        ];
        const cssUrls = [
          "https://api.mapbox.com/mapbox-gl-js/v2.16.0/mapbox-gl.css",
          "https://unpkg.com/mapbox-gl@2.16.0/dist/mapbox-gl.css",
        ];
        // ensure a CSS link exists and fallback if needed
        function ensureCss() {
          const head = document.head;
          const link = document.getElementById("mapbox-css");
          // try to fetch primary css quickly to detect network block
          fetch(cssUrls[0], { method: "HEAD", mode: "no-cors" }).catch(() => {
            /* ignore */
          });
          // If CSS is blocked, still try to load script fallbacks below
        }
        ensureCss();

        // try to load scriptUrls in order
        let attempt = 0;
        function tryLoad() {
          if (attempt >= scriptUrls.length) {
            showNote(
              "Mapbox failed to load from CDNs. Check network or disable adblocker."
            );
            console.error(
              "All Mapbox CDN attempts failed. Checked URLs:",
              scriptUrls
            );
            return;
          }
          const url = scriptUrls[attempt];
          showNote("Loading map library...");
          const s = document.createElement("script");
          s.src = url;
          s.async = false;
          s.defer = false;
          s.onload = () => {
            loaderNote.style.display = "none";
            console.info("Mapbox loaded from", url);
          };
          s.onerror = () => {
            console.warn("Failed to load Mapbox from", url);
            attempt++;
            // try next
            tryLoad();
          };
          document.body.appendChild(s);
        }
        tryLoad();
      })();
    </script>

    <!--  app.js contains defensive init -->
    <script src="app.js" defer></script>

    <noscript>
      <div style="background: #ffefc7; padding: 10px; text-align: center">
        This app requires JavaScript. Please enable JavaScript.
      </div>
    </noscript>
  </body>
</html>
